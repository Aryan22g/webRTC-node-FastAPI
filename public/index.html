<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC remote video (server -> browser)</title>
  </head>
  <body>
    <h3>Remote video from server (WebRTC)</h3>
    <video id="remoteVideo" autoplay playsinline controls></video>
    <script>
      async function start() {
        const pc = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        const remoteVideo = document.getElementById("remoteVideo");
        pc.ontrack = (event) => {
          if (remoteVideo.srcObject !== event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            console.log("Attached remote stream");
          }
        };
        pc.addTransceiver("video", { direction: "recvonly" });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const resp = await fetch("/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(
            `Signalling failed: ${resp.status} ${resp.statusText}\n${text}`
          );
        }

        const answer = await resp.json();
        await pc.setRemoteDescription(answer);
        console.log("Remote description set. Waiting for remote track...");
      }

      start().catch((err) => {
        console.error("start() failed:", err);
        alert("Error: " + err.message);
      });
    </script>
  </body>
</html>
